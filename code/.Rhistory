dat <- read.csv("/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Emma_med_den_pdx_2dx_10_04_2017.csv")
dat <- read.csv("/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Medicare_Oct17/Emma_den_med_pdx_10_04_2017.csv")
dat <- read.csv("/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Medicare_Oct17/Emma_den_med_pdx_10_04_2017.csv")
dat <- read.csv(file="/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Case_crossover_data/Emma_med_11_28_2017.csv")
dim(dat)
View(dat)
dat[1,]
names(dat)
class(dat$adate)
class(dat$ddate)
class(dat$Race_gp)
levels(dat$Race_gp)
class(dat$year)
min(dat$year)
max(dat$year)
class(dat$ddate)
sum(dat$ddate=="")
class(prov_num)
class(dat$prov_num)
blah <- as.numeric(dat$prov_num)
min(blah)
max(blah)
blah <- as.numeric(as.character(dat$prov_num))
min(blah)
min(blah[!is.na(blah)])
miax(blah[!is.na(blah)])
max(blah[!is.na(blah)])
class(dat$X_QID_)
min(dat$X_QID_)
max(dat$X_QID_)
levels(dat$Sex_gp)
class(dat$FIPS)
min(dat$FIPS)
min(dat$FIPS[!is.na(dat$FIPS)])
View(dat[,c("DODFLAG","BENE_DOD")])
adate <- Date(dat$adate)
adate <- as.Date(dat$adate)
?as.Date
dat$adate[`]
dat$adate[1]
''
""
'
aq
q
a;slkdjg
}
[]
`
`
`
dat$adate[1]
adate <- as.Date(dat$adate, format="%d%b%Y")
adate[1:10]
cbind(adate[1:10],dat$adate[1:10])
adate[1:10]
dat$adate[1:10]
dat$adate_r <- as.Date(dat$adate, format="%d%b%Y")
dat$ddate_r <- as.Date(dat$ddate, format="%d%b%Y")
dat$BENE_DOD_r <- as.Date(dat$BENE_DOD_r, format="%d%b%Y")
dat$BENE_DOD_r <- as.Date(dat$BENE_DOD, format="%d%b%Y")
dat_diff <- dat$BENE_DOD_r - dat$ddat_r
summary(dat_diff)
class(dat$BENE_DOD_r)
class(dat$ddat_r)
class(dat$ddate_r)
dat_diff <- dat$BENE_DOD_r - dat$ddate_r
summary(dat_diff)
summarize(dat_diff)
class(dat_diff)
summary(as.numeric(dat_diff))
max(dat)diff
max(dat_diff)
max(dat_diff[!is.na(dat_diff)])
min(dat_diff[!is.na(dat_diff)])
dat_diff <- dat_diff[!is.na(dat_diff)]
summary(dat_diff)
max(dat_diff)
min(dat_diff)
sum(dat_diff < 0)
length(dat_diff)
length_stay <- dat$adate_r - dat$ddate_r
max(length_stay)
min(length_stay)
length_stay <- dat$ddate_r - dat$adate_r
summary(length_stay)
max(length_stay)
min(length_stay)
min(dat_diff)
max(dat_diff)
1275/365.25
length(unique(dat$QID))
length(unique(dat$X_QID_))
dim(dat)
nrow(dat)/length(unique(dat$X_QID_))
nrow(dat)/length(unique(dat$QID))
nrow(dat)/length(unique(dat$prov_num))
max(dat$BENE_DOD_r)
max(dat$BENE_DOD_r,na.rm=T)
medi <- dat
rm(dat)
temp <- read.csv(file="/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/data_JAMA_heatwaves_paper/zip files/County_weather_1999_2010_04_06_2014.CSV")
names(temp)
?merge
names(medi)
View(temp)
temp$adate_r <- as.date(temp$link_ID)
?as.date
temp$adate_r <- as.Date(temp$link_ID)
temp$adate_r[1:10]
medi$adate_r[1:10]
min(medi$adate_r)
min(temp$adate_r)
max(medi$adate_r)
max(temp$adate_r)
dat <- merge(medi, temp, by=c("FIPS","adate_r"), all.x=T)
dim(dat)
dim(medi)
save(dat,file="/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Case_crossover_data/merged.Rdata")
dim(Dat)
dim(dat)
min(temp$adate_r)
max(temp$adate_r)
keep <- dat$adate_r <= Date("2010-12-31") & dat$adate_r >= Date("1999-01-01")
keep <- dat$adate_r <= as.Date("2010-12-31") & dat$adate_r >= as.Date("1999-01-01")
sum(keep)
dim(dat)
sum(keep)/nrow(dat)
dat <- dat[keep,]
View(dat)
save(dat,file="/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Case_crossover_data/merged.Rdata")
load(file="/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Case_crossover_data/merged.Rdata")
View(dat)
head(dat)
View(head(dat))
names(dat)
class(dat$FIPS)
CSA.names <- c("Chicago-Naperville, IL-IN-WI", "New York-Newark, NY-NJ-CT-PA",
"Miami-Fort Lauderdale-Port St. Lucie, FL", "Houston-The Woodlands, TX", "Los Angeles-Long Beach, CA")
for(nm in CSA.names){
}
nm <- CSA.names[1]
nm
CSA.fips <- read.csv(file=paste0("/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/R_code/MORETreeS/Data/CSAs/",nm,"_FIPS_codes.csv"),header = F)[,1]
CSA.fips
dat_sub <- subset(dat,FIPS %in% CSA.fips & Emer_adm==1,select=c("QID","Race_gp","Sex_gp","Dual","diag1","adate","temperature_daily_county_mean","temperature_daily_county_min","temperature_daily_county_max"))
save(dat_sub,file=paste0("/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Case_crossover_data/merged_",nm,".Rdata"))
CSA.names <- c("Chicago-Naperville, IL-IN-WI", "New York-Newark, NY-NJ-CT-PA",
"Miami-Fort Lauderdale-Port St. Lucie, FL", "Houston-The Woodlands, TX", "Los Angeles-Long Beach, CA")
for(nm in CSA.names){
# Read in list of relevant FIPS codes
CSA.fips <- read.csv(file=paste0("/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/R_code/MORETreeS/Data/CSAs/",nm,"_FIPS_codes.csv"),header = F)[,1]
# Extract data for this city, keeping only relevant variables and emergency admissions only
dat_sub <- subset(dat,FIPS %in% CSA.fips & Emer_adm==1,select=c("QID","Race_gp","Sex_gp","Dual","diag1","adate","temperature_daily_county_mean","temperature_daily_county_min","temperature_daily_county_max"))
# Save dataset
save(dat_sub,file=paste0("/nfs/home/E/ethomas/shared_space/ci3_nsaph/Emma/Data/Case_crossover_data/merged_",nm,".Rdata"))
}
dim(dat_sub)
names(dat_sub)
length(unique(dat_sub$QID))
dim(dat)
require(fst)
read_fst(file="./shared_space/ci3_nsaph/Emma/Data/Case_crossover_data/zipcode_er_part14.fst")
?read_fst
read_fst(path="./shared_space/ci3_nsaph/Emma/Data/Case_crossover_data/zipcode_er_part14.fst")
require(NSAPHutils)
devtools::install_github("NSAPH/NSAPHutils")
require(NSAPHutils)
require(fst)
dir <- "shared_space/ci3_health_data/medicare/gen_admission/1999_2016/targeted_conditions/cache_data/admissions_by_year/"
getwd()
print(list.files(dir))
print(fst.metadata(paste0(dir,"admissions_2000.fst")))
View(fst.metadata(paste0(dir,"admissions_2000.fst")))
require(icd)
getwd()
library(NSAPHutils)
setwd("/nfs/home/E/ethomas/shared_space/ci3_analysis/moretrees2/code/")
library(data.table)
library(fst)
library(icd)
admission_columns <- c("zipcode_r", "qid", "adate",
"icd9", "ccs_l1", "ccs_l2",
"ccs_l3", "ccs_l4")
pm_path <- "../data/daily_pm/"
temp_path <- "../data/temperature/"
ozone_path <- "../data/ozone/"
zipReverse <- function(x){
x <- as.character(x)
l <- str_length(x)
if (l != 5) {
x <- paste0(c(rep("0", 5 - l), x), collapse = "")
}
x <- paste0(rev(strsplit(x, NULL)[[1]]), collapse = "")
return(x)
}
year_ <- 2001
admissions <- read_fst(paste0("../data/admissions_cvd/admissions_cvd_", year_, ".fst"))
# select control days (randomly exactly one week before or after)
admissions$cdate <- admissions$adate + sample(c(-7, 7), nrow(admissions), replace = T)
# merge in lag01 PM2.5 data for case and control days
admissions$pm25_case <- numeric(nrow(admissions))
admissions$pm25_control <- numeric(nrow(admissions))
for (i in 1:(nrow(admissions))) {
case0 <- str_remove_all(as.character(admissions$adate[i]), pattern = "-")
case1 <- str_remove_all(as.character(admissions$adate[i] - 1), pattern = "-")
control0 <- str_remove_all(as.character(admissions$cdate[i]), pattern = "-")
control1 <- str_remove_all(as.character(admissions$cdate[i] - 1), pattern = "-")
zip <- zipReverse(admissions$zipcode_r[i])
# case day PM2.5 lag01
case_pm0 <- subset(read_rds(paste0(pm_path, case0, ".rds")), ZIP == zip)$pm25
case_pm1 <- subset(read_rds(paste0(pm_path, case1, ".rds")), ZIP == zip)$pm25
admissions$pm25_case[i] <- (case_pm0 + case_pm1) / 2
# control day PM2.5 lag01
control_pm0 <- subset(read_rds(paste0(pm_path, control0, ".rds")), ZIP == zip)$pm25
control_pm1 <- subset(read_rds(paste0(pm_path, control1, ".rds")), ZIP == zip)$pm25
admissions$pm25_control[i] <- (control_pm0 + control_pm1) / 2
# print
if (i %% 1000 == 0) print(i / nrow(admissions) * 100)
}
library(stringr)
for (i in 1:(nrow(admissions))) {
case0 <- str_remove_all(as.character(admissions$adate[i]), pattern = "-")
case1 <- str_remove_all(as.character(admissions$adate[i] - 1), pattern = "-")
control0 <- str_remove_all(as.character(admissions$cdate[i]), pattern = "-")
control1 <- str_remove_all(as.character(admissions$cdate[i] - 1), pattern = "-")
zip <- zipReverse(admissions$zipcode_r[i])
# case day PM2.5 lag01
case_pm0 <- subset(read_rds(paste0(pm_path, case0, ".rds")), ZIP == zip)$pm25
case_pm1 <- subset(read_rds(paste0(pm_path, case1, ".rds")), ZIP == zip)$pm25
admissions$pm25_case[i] <- (case_pm0 + case_pm1) / 2
# control day PM2.5 lag01
control_pm0 <- subset(read_rds(paste0(pm_path, control0, ".rds")), ZIP == zip)$pm25
control_pm1 <- subset(read_rds(paste0(pm_path, control1, ".rds")), ZIP == zip)$pm25
admissions$pm25_control[i] <- (control_pm0 + control_pm1) / 2
# print
if (i %% 1000 == 0) print(i / nrow(admissions) * 100)
}
library(readr)
for (i in 1:(nrow(admissions))) {
case0 <- str_remove_all(as.character(admissions$adate[i]), pattern = "-")
case1 <- str_remove_all(as.character(admissions$adate[i] - 1), pattern = "-")
control0 <- str_remove_all(as.character(admissions$cdate[i]), pattern = "-")
control1 <- str_remove_all(as.character(admissions$cdate[i] - 1), pattern = "-")
zip <- zipReverse(admissions$zipcode_r[i])
# case day PM2.5 lag01
case_pm0 <- subset(read_rds(paste0(pm_path, case0, ".rds")), ZIP == zip)$pm25
case_pm1 <- subset(read_rds(paste0(pm_path, case1, ".rds")), ZIP == zip)$pm25
admissions$pm25_case[i] <- (case_pm0 + case_pm1) / 2
# control day PM2.5 lag01
control_pm0 <- subset(read_rds(paste0(pm_path, control0, ".rds")), ZIP == zip)$pm25
control_pm1 <- subset(read_rds(paste0(pm_path, control1, ".rds")), ZIP == zip)$pm25
admissions$pm25_control[i] <- (control_pm0 + control_pm1) / 2
# print
if (i %% 1000 == 0) print(i / nrow(admissions) * 100)
}
i
dim(admissions)
require(readr)
require(fst)
rm(list = ls())
ozone <- read_fst("../data/ozone_data/PREDICTIONGeneral2_OZONE_zipcode_SUBSET_2000_2012.rds")
ozone <- read_rds("../data/ozone_data/PREDICTIONGeneral2_OZONE_zipcode_SUBSET_2000_2012.rds")
dim(ozone)
names(ozone[1:20])
colnames(ozone)
rownames(ozone)
class(ozone)
